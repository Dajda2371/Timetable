<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Config Editor</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        .section { margin-bottom: 20px; }
        input, select { margin: 5px 0; padding: 8px; width: 100%; }
        .button-group {
            display: flex;
            gap: 10px; /* Space between buttons */
            margin-bottom: 20px;
        }
        button { padding: 10px; background: blue; color: white; border: none; cursor: pointer; }
        #example-config-button {
            background-color: blue;
            color: white;
            border: none;
            cursor: pointer;
            display: none; /* Initially hidden */
        }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Config Editor</h1>
        
        <div class="section" id="teachers-section">
            <h2>Teachers</h2>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Subjects</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="teachers-list"></tbody>
            </table>
            <button id="add-teacher">Add Teacher</button>
        </div>

        <div class="section" id="classes-section">
            <h2>Classes</h2>
            <table>
                <thead>
                    <tr>
                        <th>Grade</th>
                        <th>Class Name</th>
                        <th>Class Teacher</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="classes-list"></tbody>
            </table>
            <button id="add-class">Add Class</button>
        </div>

        <div class="section" id="time-grant-section">
            <h2>Time Grant</h2>
            <table>
                <thead>
                    <tr id="time-grant-header-row">
                        <!-- Dynamic headers go here -->
                    </tr>
                </thead>
                <tbody id="time-grant-list"></tbody>
            </table>
            <button id="add-time-grant">Add Subject</button>
        </div>

        <div class="section" id="schedule-config-section">
            <h2>Schedule Config</h2>
            <table>
                <thead>
                    <tr>
                        <th>Day</th>
                        <th>Max Periods</th>
                        <th>Lunch Breaks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="schedule-config-list"></tbody>
            </table>
            <button id="add-schedule-config">Add Day</button>
        </div>
        
        <div class="button-group">
            <button id="save-config">Save Config</button>
            <button id="generateButton">Generate Timetables</button>
            <button id="example-config-button">Use Example Config</button>
        </div>
        <p id="status"></p>
    </div>
    
    <script>
        let config = {};
        const exampleConfigButton = document.getElementById("example-config-button");

        async function loadConfig() {
            try {
                const response = await fetch("/config");
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log("404 error")
                        // Config file not found, show the example config button
                        exampleConfigButton.style.display = "block";
                        config = {
                            teachers: [],
                            classes: [],
                            time_grant: {},
                            schedule_config: {}
                        };
                        renderAll();
                        return;
                    }
                    throw new Error("Failed to load config");
                }

                const loadedConfig = await response.json();
                
                // Check if the loaded config is empty or contains only empty data
                const isEmptyConfig = Object.values(loadedConfig).every(
                    (value) => Array.isArray(value) && value.length === 0 || Object.keys(value).length === 0
                );
                console.log(isEmptyConfig)

                if (isEmptyConfig) {
                    console.log("empty config")
                    exampleConfigButton.style.display = "block";
                } else {
                    console.log("config loaded")
                    config = loadedConfig;
                }

                renderAll();
                exampleConfigButton.style.display = "none"; // Hide the button if config is loaded
            } catch (error) {
                console.error("Error loading config:", error);
                console.log("error")
                config = {
                    teachers: [],
                    classes: [],
                    time_grant: {},
                    schedule_config: {}
                };
                renderAll();
                exampleConfigButton.style.display = "block"; // Show the button if there's an error
            }
        }

        async function loadExampleConfig() {
            try {
                const response = await fetch("/example-config");
                if (!response.ok) throw new Error("Failed to load example config");
                const exampleConfig = await response.json();
                config = exampleConfig;
                await saveConfig();
                exampleConfigButton.style.display = "none";
                renderAll();
                document.getElementById("status").textContent = "Example config loaded and saved.";
            } catch (error) {
                console.error("Error loading example config:", error);
                document.getElementById("status").textContent = "Failed to load example config.";
            }
        }
        function renderAll() {
            renderTeachers();
            renderClasses();
            renderTimeGrant();
            renderScheduleConfig();
        }

        function renderTeachers() {
            const teachersList = document.getElementById("teachers-list");
            teachersList.innerHTML = "";
            config.teachers.forEach((teacher, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td><input type="text" value="${teacher.name}" onchange="updateTeacher(${index}, 'name', this.value)"></td>
                    <td><input type="text" value="${teacher.subjects.join(', ')}" onchange="updateTeacher(${index}, 'subjects', this.value.split(', '))"></td>
                    <td><button onclick="removeTeacher(${index})">Remove</button></td>
                `;
                teachersList.appendChild(row);
            });
        }

        function addTeacher() {
            config.teachers.push({ name: "", subjects: [] });
            renderTeachers();
        }

        function updateTeacher(index, field, value) {
            config.teachers[index][field] = value;
        }

        function removeTeacher(index) {
            config.teachers.splice(index, 1);
            renderTeachers();
        }

        function renderClasses() {
            const classesList = document.getElementById("classes-list");
            classesList.innerHTML = "";
            config.classes.forEach((cls, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td><input type="number" value="${cls.grade}" onchange="updateClass(${index}, 'grade', this.value)"></td>
                    <td><input type="text" value="${cls.class_name}" onchange="updateClass(${index}, 'class_name', this.value)"></td>
                    <td><input type="text" value="${cls.class_teacher}" onchange="updateClass(${index}, 'class_teacher', this.value)"></td>
                    <td><button onclick="removeClass(${index})">Remove</button></td>
                `;
                classesList.appendChild(row);
            });
        }

        function addClass() {
            config.classes.push({ grade: "", class_name: "", class_teacher: "" });
            renderClasses();
            renderTimeGrant();
        }

        function updateClass(index, field, value) {
            const oldGrade = config.classes[index].grade;

            config.classes[index][field] = value;

            if (field === "grade") {
                const newGrade = value;

                // Create new grade in time_grant if needed
                if (!config.time_grant[newGrade]) {
                    config.time_grant[newGrade] = {};
                }

                // Check if old grade is still used
                const oldGradeStillUsed = config.classes.some((cls, i) => i !== index && cls.grade == oldGrade);
                if (!oldGradeStillUsed) {
                    delete config.time_grant[oldGrade];
                }

                renderTimeGrant();
            }
        }

        function removeClass(index) {
            const grade = config.classes[index].grade;
            config.classes.splice(index, 1);
            renderClasses();
            renderTimeGrant();
        }

        function renderTimeGrant() {
            const list = document.getElementById("time-grant-list");
            const headerRow = document.getElementById("time-grant-header-row");
            list.innerHTML = "";

            const grades = Object.keys(config.time_grant);

            // Generate header row with one <th> per grade
            headerRow.innerHTML = `<th>Subject</th>` +
                grades.map(grade => `<th>Grade ${grade}</th>`).join("") +
                `<th>Actions</th>`;

            const subjects = new Set();
            grades.forEach(grade => {
                Object.keys(config.time_grant[grade]).forEach(subject => subjects.add(subject));
            });

            subjects.forEach(subject => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td><input type="text" value="${subject}" onchange="updateTimeGrantSubject('${subject}', this.value)"></td>
                    ${grades.map(grade => `
                        <td><input type='number' value='${config.time_grant[grade][subject] || 0}' 
                        onchange='updateTimeGrant("${grade}", "${subject}", this.value)'></td>
                    `).join("")}
                    <td><button onclick="removeTimeGrant('${subject}')">Remove</button></td>
                `;
                list.appendChild(row);
            });
        }

        function updateTimeGrant(grade, subject, value) {
            config.time_grant[grade][subject] = parseInt(value) || 0;
        }

        function updateTimeGrantSubject(oldSubject, newSubject) {
            Object.keys(config.time_grant).forEach(grade => {
                config.time_grant[grade][newSubject] = config.time_grant[grade][oldSubject];
                delete config.time_grant[grade][oldSubject];
            });
            renderTimeGrant();
        }

        function removeTimeGrant(subject) {
            Object.keys(config.time_grant).forEach(grade => {
                delete config.time_grant[grade][subject];
            });
            renderTimeGrant();
        }

        function removeClass(index) {
            const removedGrade = config.classes[index].grade;
            config.classes.splice(index, 1);

            // Check if any class with this grade remains
            const gradeStillExists = config.classes.some(cls => cls.grade == removedGrade);
            if (!gradeStillExists) {
                delete config.time_grant[removedGrade];
            }

            renderClasses();
            renderTimeGrant();
        }

        function renderScheduleConfig() {
            const list = document.getElementById("schedule-config-list");
            list.innerHTML = "";
            Object.keys(config.schedule_config).forEach(day => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td><input type="text" value="${day}" onchange="updateScheduleDay('${day}', this.value)"></td>
                    <td><input type="number" value="${config.schedule_config[day].max_periods}" onchange="updateSchedule('${day}', 'max_periods', this.value)"></td>
                    <td><input type="text" value="${config.schedule_config[day].lunch_breaks.join(', ')}" onchange="updateSchedule('${day}', 'lunch_breaks', this.value.split(',').map(Number))"></td>
                    <td><button onclick="removeScheduleConfig('${day}')">Remove</button></td>
                `;
                list.appendChild(row);
            });
        }

        function updateSchedule(day, field, value) {
            config.schedule_config[day][field] = value;
        }

        function updateScheduleDay(oldDay, newDay) {
            config.schedule_config[newDay] = config.schedule_config[oldDay];
            delete config.schedule_config[oldDay];
            renderScheduleConfig();
        }

        function removeScheduleConfig(day) {
            delete config.schedule_config[day];
            renderScheduleConfig();
        }

        async function saveConfig() {
            try {
                const response = await fetch("/save-config", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(config),
                });
                const data = await response.json();
                document.getElementById("status").textContent = data.message;
                
                // Check if the config is now empty and show the button if so
                const isEmptyConfig = Object.values(config).every(
                    (value) => Array.isArray(value) && value.length === 0 || Object.keys(value).length === 0
                );
                if (isEmptyConfig) {
                    exampleConfigButton.style.display = "block";
                } else {
                    exampleConfigButton.style.display = "none";
                }
                renderAll();
            } catch (error) {
                console.error("Error saving config:", error);
                document.getElementById("status").textContent = "Failed to save config.";
            }
        }

        document.getElementById("add-teacher").addEventListener("click", addTeacher);
        document.getElementById("add-class").addEventListener("click", addClass);

        document.getElementById("add-time-grant").addEventListener("click", () => {
            Object.keys(config.time_grant).forEach(grade => {
                config.time_grant[grade]["New Subject"] = 0;
            });
            renderTimeGrant();
        });

        document.getElementById("add-schedule-config").addEventListener("click", () => {
            config.schedule_config["New Day"] = { max_periods: 0, lunch_breaks: [] };
            renderScheduleConfig();
        });

        document.getElementById("save-config").addEventListener("click", saveConfig);

        document.getElementById("generateButton").addEventListener("click", function() {
            fetch("/generate")
                .then(response => response.json())
                .then(data => {
                    document.getElementById("status").textContent = data.message;
                })
                .catch(error => {
                    console.error("Error:", error);
                    document.getElementById("status").textContent = "Failed to generate timetables.";
                });
        });

        exampleConfigButton.addEventListener("click", loadExampleConfig);

        loadConfig();
    </script>
</body>
</html>
